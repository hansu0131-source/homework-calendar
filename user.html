<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ° ë‚­ - ìˆ™ì œ ì²´í¬</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

<style>
    body {
        background: #FFE9F4; /* ë‹¨ìƒ‰ í•‘í¬ */
        font-family: Pretendard, sans-serif;
        margin: 0;
        padding: 20px;
    }

    h1 {
        text-align: center;
        color: #ff6fa8;
        margin-bottom: 5px;
    }

    .tag {
        text-align: center;
        font-size: 13px;
        color: #fff;
        background: #ff9ac5;
        padding: 4px 12px;
        border-radius: 999px;
        display: inline-block;
        margin-left: 50%;
        transform: translateX(-50%);
        margin-bottom: 18px;
    }

    .box {
        background: white;
        padding: 12px;
        border-radius: 12px;
        box-shadow: 0 3px 12px rgba(255,140,170,0.25);
        margin-bottom: 20px;
    }

    .section-title {
        font-size: 16px;
        font-weight: 700;
        color: #ff6fa8;
        margin-bottom: 6px;
    }

    textarea {
        width: 100%;
        min-height: 70px;
        border-radius: 8px;
        border: 1px solid #ffc9dd;
        padding: 10px;
        resize: vertical;
        background: #fff;
        font-family: inherit;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 14px;
        overflow: hidden;
        box-shadow: 0 3px 12px rgba(255,140,170,0.25);
    }

    th {
        background: #ff9ac5;
        padding: 8px;
        color: white;
        font-weight: 600;
        text-align: center;
    }

    td {
        border-bottom: 1px solid #ffc9dd;
        padding: 6px;
        text-align: center;
    }

    input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: #ff6fa8;
    }

    .readonly-box {
        border-radius: 8px;
        border: 1px solid #ffc9dd;
        padding: 6px;
        background: #fff6fb;
        width: 90%;
        text-align: center;
    }
</style>
</head>

<body>

<h1>ğŸ° ë‚­ - ìˆ™ì œ ì²´í¬</h1>
<div class="tag">ì‚¬ìš©ì ID: ë‚­ (í•‘í¬)</div>

<!-- ğŸ¥• ê´€ë¦¬ì â†’ ì‚¬ìš©ì ë©”ì‹œì§€ -->
<div class="box">
    <div class="section-title">ğŸ¥• ê´€ë¦¬ì í•œë§ˆë””</div>
    <div id="adminMessageBox" style="white-space:pre-line; padding:10px; background:#fff0f7; border-radius:8px; border:1px solid #ffc9dd;">
        (ì•„ì§ ê´€ë¦¬ìê°€ ë©”ì‹œì§€ë¥¼ ë‚¨ê¸°ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤)
    </div>
</div>

<!-- ğŸ° ì‚¬ìš©ì â†’ ê´€ë¦¬ì ë©”ì‹œì§€ -->
<div class="box">
    <div class="section-title">ğŸ° ì˜¤ëŠ˜ì˜ í•œë§ˆë”” (ì‚¬ìš©ìê°€ ê´€ë¦¬ìì—ê²Œ)</div>
    <textarea id="userMessage" placeholder="ê´€ë¦¬ìì—ê²Œ ë‚¨ê¸°ê³  ì‹¶ì€ ë§"></textarea>
    <button onclick="saveUserMessage()" style="
        margin-top:10px; padding:8px 14px;
        border:none; border-radius:8px;
        background:#ff6fa8; color:white; font-weight:600; cursor:pointer;
    ">ì €ì¥</button>
</div>

<!-- ì²´í¬ë¦¬ìŠ¤íŠ¸ í…Œì´ë¸” -->
<table id="table">
    <thead id="thead"></thead>
    <tbody id="tbody"></tbody>
</table>

<script>
/* Firebase Setup */
const firebaseConfig = {
    apiKey: "AIzaSyAHmLNi5VOuAE-gXnAg-fEfzylPZvzvfVo",
    authDomain: "daily-checklist-91e5a.firebaseapp.com",
    projectId: "daily-checklist-91e5a",
    storageBucket: "daily-checklist-91e5a.firebasestorage.app",
    messagingSenderId: "66394691958",
    appId: "1:66394691958:web:cf91f295456a2e10d18257",
    measurementId: "G-87WK4N4EGH"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const configRef = db.collection("config").doc("checklist");
const spacesRef = db.collection("spaces");
const todayRef = db.collection("today").doc("messages");

let fields = [];

/* ê´€ë¦¬ì ë©”ì‹œì§€ ì‹¤ì‹œê°„ ë°˜ì˜ */
todayRef.onSnapshot(doc => {
    if (doc.exists) {
        document.getElementById("adminMessageBox").innerText =
            doc.data().adminMessage || "(ì•„ì§ ê´€ë¦¬ìê°€ ë©”ì‹œì§€ë¥¼ ë‚¨ê¸°ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤)";
    }
});

/* ì‚¬ìš©ì ë©”ì‹œì§€ ì €ì¥ */
function saveUserMessage() {
    const msg = document.getElementById("userMessage").value;
    todayRef.set(
        { userMessage: msg, date: new Date().toISOString() },
        { merge: true }
    );
}

/* í•­ëª© ì‹¤ì‹œê°„ */
configRef.onSnapshot(doc => {
    if (!doc.exists) return;
    fields = doc.data().fields;
    renderTable();
});

/* í–‰ ì‹¤ì‹œê°„ */
spacesRef.onSnapshot(() => renderTable());

/* í…Œì´ë¸” ë Œë”ë§ */
function renderTable() {
    const thead = document.getElementById("thead");
    const tbody = document.getElementById("tbody");

    thead.innerHTML = `
        <tr>
            <th>ë‹‰ë„¤ì„</th>
            <th>ì•„ì´ë””</th>
            ${fields.map(f => `<th>${f}</th>`).join("")}
            <th>ë©”ëª¨</th>
        </tr>
    `;

    tbody.innerHTML = "";

    spacesRef.get().then(res => {
        res.forEach(doc => {
            const data = doc.data();
            const checks = data.checks || {};

            const row = document.createElement("tr");

            row.innerHTML = `
                <td><div class="readonly-box">${data.nickname}</div></td>
                <td><div class="readonly-box">${data.userid}</div></td>

                ${fields.map(f => `
                    <td>
                        <input type="checkbox"
                            ${checks[f] ? "checked" : ""}
                            onchange="updateCheck('${doc.id}', '${f}', this.checked)">
                    </td>
                `).join("")}

                <td><textarea onchange="update('${doc.id}', 'memo', this.value)">${data.memo || ""}</textarea></td>
            `;

            tbody.appendChild(row);
        });
    });
}

/* ë©”ëª¨ ì—…ë°ì´íŠ¸ */
function update(id, field, value) {
    spacesRef.doc(id).update({ [field]: value });
}

/* ì²´í¬ë°•ìŠ¤ ì—…ë°ì´íŠ¸ */
function updateCheck(id, field, value) {
    spacesRef.doc(id).update({ [`checks.${field}`]: value });
}
</script>

</body>
</html>

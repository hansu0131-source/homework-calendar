<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>C9 í† ë¼ ìˆ™ì œ ìº˜ë¦°ë” ğŸ° (ì‹¤ì‹œê°„ ì—°ë™)</title>
<style>
  /* --- ğŸ° íŒŒìŠ¤í…” í•‘í¬ í…Œë§ˆ ì„¤ì • --- */
  :root {
    --bg-color: #fff0f5; 
    --container-bg: #ffffff;
    --primary-pink: #ffb6c1; 
    --dark-pink: #ff8da1; 
    --light-pink-hover: #fff5f8;
    --border-pink: #ffe4e1; 
    --text-gray: #555;
    --text-dark: #333;
    --accent-blue: #aed9e0; 
    --shadow-color: rgba(255, 182, 193, 0.2);
    --radius-soft: 15px;
    --radius-round: 25px;
  }

  /* --- ê³µí†µ ìŠ¤íƒ€ì¼ --- */
  body { 
    font-family: 'Pretendard', 'Malgun Gothic', sans-serif; 
    background-color: var(--bg-color);
    background-image: radial-gradient(#ffe4e1 1px, transparent 1px);
    background-size: 20px 20px;
    padding: 20px; margin: 0; color: var(--text-gray);
  }
  input, button, textarea, select { font-family: inherit; box-sizing: border-box; outline: none; }
  h2, h3 { color: var(--text-dark); }

  /* ë ˆì´ì•„ì›ƒ */
  .wrapper { display: flex; gap: 20px; max-width: 1400px; margin: 0 auto; align-items: flex-start; }
  .sidebar, .sidebar-right { width: 260px; background: var(--container-bg); padding: 25px; border-radius: var(--radius-round); box-shadow: 0 8px 25px var(--shadow-color); flex-shrink: 0; max-height: 800px; overflow-y: auto; border: 2px solid #fff; }
  .sidebar-title { font-size: 1.1rem; font-weight: bold; margin: 0 0 20px 0; color: var(--text-dark); border-bottom: 3px dotted var(--border-pink); padding-bottom: 15px; text-align: center; }
  .container { flex: 1; background: var(--container-bg); padding: 30px; border-radius: var(--radius-round); box-shadow: 0 8px 25px var(--shadow-color); border: 2px solid #fff; position: relative; }
  
  /* ë¡œë”© í‘œì‹œ */
  #loading-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center; z-index: 999; border-radius: var(--radius-round); font-weight: bold; color: var(--dark-pink); }

  /* ë²„íŠ¼ ë° ìš”ì†Œ ìŠ¤íƒ€ì¼ (ì´ì „ê³¼ ë™ì¼) */
  .shortcut-btn { width: 100%; background: #fff; border: 2px solid var(--border-pink); padding: 12px 15px; border-radius: var(--radius-soft); margin-bottom: 10px; cursor: pointer; text-align: left; transition: all 0.2s ease; display: flex; justify-content: space-between; align-items: center; }
  .shortcut-btn:hover { background: var(--light-pink-hover); border-color: var(--primary-pink); transform: translateY(-2px); }
  .shortcut-date { font-weight: bold; color: var(--text-gray); font-size: 14px; }
  .shortcut-count { background: var(--primary-pink); color: white; font-size: 12px; padding: 4px 8px; border-radius: 12px; font-weight: bold; }

  .rank-item { display: flex; align-items: center; justify-content: space-between; background: #fff; border-bottom: 1px dashed var(--border-pink); padding: 12px 5px; margin-bottom: 5px; }
  .rank-info { display: flex; flex-direction: column; }
  .rank-nick { font-weight: bold; color: var(--text-dark); font-size: 14px; }
  .rank-id { font-size: 11px; color: var(--primary-pink); }
  .rank-badge { background: var(--accent-blue); color: white; font-weight: bold; border-radius: 12px; padding: 5px 10px; font-size: 13px; box-shadow: 0 2px 5px rgba(174, 217, 224, 0.4); }
  .rank-icon { margin-right: 5px; font-size: 14px; }

  .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
  .calendar-header h2 { margin: 0; color: var(--text-dark); font-size: 1.4rem; font-weight: 800; }
  .calendar-header h2::before { content: "ğŸ° "; }
  .nav-btn { background: white; border: 2px solid var(--border-pink); border-radius: 12px; padding: 8px 14px; cursor: pointer; color: var(--primary-pink); font-weight: bold; transition: 0.2s; }
  .nav-btn:hover { background: var(--primary-pink); color: white; border-color: var(--primary-pink); }
  .nav-btn.del-icon { color: #ff8a80; border-color: #ffcdd2; margin-right: 5px; font-size: 1.1rem;} 
  .nav-btn.del-icon:hover { background: #ff8a80; color: white; border-color: #ff8a80; }
  .nav-btn.edit-icon { color: #81d4fa; border-color: #b3e5fc; margin-right: 5px; font-size: 1.1rem;} 
  .nav-btn.edit-icon:hover { background: #81d4fa; color: white; border-color: #81d4fa; }

  .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-bottom: 25px;}
  .day-name { text-align: center; font-size: 0.9rem; color: var(--primary-pink); font-weight: bold; padding-bottom: 10px; }
  .day-cell { height: 70px; background: #fff; border: 2px solid var(--border-pink); border-radius: var(--radius-soft); position: relative; cursor: pointer; transition: all 0.2s ease; padding: 6px; display: flex; flex-direction: column; justify-content: space-between; }
  .day-cell:hover { border-color: var(--primary-pink); background: var(--light-pink-hover); transform: scale(1.03); z-index: 1;}
  .day-number { font-size: 14px; font-weight: bold; color: var(--text-gray); }
  .has-homework { background-color: #fff0f3 !important; border: 2px solid var(--primary-pink) !important; }
  .hw-badge { align-self: flex-end; background-color: var(--dark-pink); color: white; font-size: 11px; font-weight: bold; padding: 3px 7px; border-radius: 10px; box-shadow: 1px 1px 3px rgba(255, 182, 193, 0.5); }

  #nickname-view { display: none; border-top: 3px dotted var(--border-pink); padding-top: 25px; animation: fadeIn 0.3s; }
  .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
  .section-title { font-size: 1.1rem; color: var(--text-dark); font-weight: bold; margin: 0; }
  .section-title::before { content: "ğŸ¥• "; }
  .btn-add-show { background-color: var(--primary-pink); color: white; border: none; padding: 10px 18px; border-radius: var(--radius-soft); font-size: 13px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 10px var(--shadow-color); transition: 0.2s; }
  .btn-add-show:hover { background-color: var(--dark-pink); transform: translateY(-2px); }

  .nick-list { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 25px; }
  .nick-btn { background: #fff; border: 2px solid var(--border-pink); border-radius: var(--radius-soft); padding: 15px 5px; font-size: 14px; font-weight: bold; color: var(--text-gray); cursor: pointer; transition: all 0.2s; text-align: center; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
  .nick-btn:hover { transform: translateY(-3px); box-shadow: 0 5px 10px var(--shadow-color); }
  .nick-btn.active { border-color: var(--primary-pink); background-color: var(--light-pink-hover); color: var(--text-dark); box-shadow: 0 0 0 2px var(--primary-pink) inset; }
  
  .status-todo { border-color: #ffcdd2; color: #e57373; background-color: #ffebee; } 
  .status-partial { background-color: #fff3e0; border-color: #ffe0b2; color: #ff9800; } 
  .status-done { background-color: #e8f5e9; border-color: #c8e6c9; color: #4caf50; } 

  #add-form { display: none; background: #fff5f8; border: 3px dashed var(--primary-pink); padding: 20px; border-radius: var(--radius-round); margin-bottom: 25px; animation: slideUp 0.2s; }
  .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
  .form-group { flex: 1; }
  .form-label { font-size: 13px; color: var(--text-dark); margin-bottom: 6px; display: block; font-weight: bold; }
  .form-input { width: 100%; padding: 12px; border: 2px solid var(--border-pink); border-radius: var(--radius-soft); font-size: 14px; background: #fff; }
  .radio-group { display: flex; gap: 20px; margin-bottom: 5px; background: #fff; padding: 10px; border-radius: var(--radius-soft); border: 2px solid var(--border-pink); }
  .radio-label { display: flex; align-items: center; gap: 8px; font-size: 14px; cursor: pointer; font-weight: bold; color: var(--text-gray); }
  input[type="radio"] { accent-color: var(--primary-pink); transform: scale(1.2); }
  .btn-register { width: 100%; background-color: var(--primary-pink); color: white; border: none; padding: 15px; border-radius: var(--radius-soft); font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 15px; box-shadow: 0 4px 10px var(--shadow-color); transition: 0.2s; }
  .btn-register:hover { background-color: var(--dark-pink); transform: translateY(-2px); }
  .btn-register.edit-mode { background-color: #aed9e0; }

  #detail-card { display: none; margin-top: 25px; background: #fff9fb; border-radius: var(--radius-round); padding: 25px; border: 3px solid var(--border-pink); animation: slideUp 0.3s; box-shadow: 0 10px 25px rgba(255, 182, 193, 0.15); }
  .card-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px dotted var(--border-pink); padding-bottom: 15px; margin-bottom: 20px; }
  .user-info h3 { margin: 0; font-size: 1.2rem; color: var(--text-dark); font-weight: 800; }
  .user-id { font-size: 0.9rem; color: var(--primary-pink); font-weight: bold; }
  .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
  .stat-box { background: white; padding: 15px; border-radius: var(--radius-soft); text-align: center; border: 2px solid var(--border-pink); box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
  .stat-label { font-size: 0.85rem; color: var(--text-gray); display: block; margin-bottom: 5px; }
  .stat-value { font-size: 1.3rem; font-weight: 900; color: var(--text-dark); }
  .stat-value.money { color: var(--primary-pink); } .stat-value.reverse { color: var(--dark-pink); } 
  .task-box { background: white; padding: 20px; border-radius: var(--radius-soft); border: 2px solid var(--border-pink); margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
  .task-label { font-size: 0.95rem; font-weight: bold; margin-bottom: 10px; display: block; color: var(--text-dark); }
  .task-content { font-size: 1.05rem; line-height: 1.5; color: var(--text-dark); margin-bottom: 15px; word-break: keep-all; background: var(--light-pink-hover); padding: 15px; border-radius: 10px; }
  .status-control { margin-top: 20px; border-top: 3px dotted var(--border-pink); padding-top: 20px; }
  .status-options { display: flex; gap: 8px; margin-bottom: 15px; }
  .status-radio { display: none; }
  .status-label { flex: 1; text-align: center; padding: 12px; border-radius: var(--radius-soft); cursor: pointer; font-size: 13px; font-weight: bold; color: var(--text-gray); background: #fff; border: 2px solid var(--border-pink); display: flex; align-items: center; justify-content: center; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
  input[type="radio"]:checked + .status-label.lbl-todo { background: #ff8a80; color: white; border-color: #ff8a80; }
  input[type="radio"]:checked + .status-label.lbl-partial { background: #ffb74d; color: white; border-color: #ffb74d; }
  input[type="radio"]:checked + .status-label.lbl-done { background: #81c784; color: white; border-color: #81c784; }
  .memo-input { width: 100%; box-sizing: border-box; padding: 15px; border: 2px solid var(--border-pink); border-radius: var(--radius-soft); font-size: 14px; resize: vertical; min-height: 70px; margin-bottom: 10px; background: #fff; transition: 0.2s; }
  .btn-group { display: flex; gap: 10px; margin-top: 20px; }
  .btn-soop { width: 100%; background-color: var(--accent-blue); color: white; border: none; padding: 15px; border-radius: var(--radius-soft); text-decoration: none; font-weight: bold; cursor: pointer; text-align: center; font-size: 15px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(174, 217, 224, 0.4); transition: 0.2s; }
  .btn-complete { margin-top: 15px; width: 100%; background: var(--dark-pink); border: none; color: white; padding: 15px; border-radius: var(--radius-soft); cursor: pointer; font-size: 15px; font-weight: bold; box-shadow: 0 4px 10px rgba(255, 141, 161, 0.4); transition: 0.2s; }
  .btn-complete:hover { background-color: #e67a8f; transform: translateY(-2px); }
  .no-data-msg { font-size: 14px; color: #aaa; text-align: center; padding: 30px 0; font-style: italic; }

  @media (max-width: 1024px) {
    .wrapper { flex-direction: column; }
    .sidebar, .sidebar-right { width: 100%; box-sizing: border-box; max-height: 250px; }
    .container { padding: 20px; width: 100%; box-sizing: border-box;}
  }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  @keyframes slideUp { from { transform: translateY(15px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
</style>
</head>
<body>

<div class="wrapper">
  
  <div class="sidebar">
    <div class="sidebar-title">ğŸ° ìˆ™ì œ ê¸°ë¡ë¶€</div>
    <div id="sidebar-list"></div>
  </div>

  <div class="container">
    <div id="loading-overlay">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘... ğŸ¥•</div>
    <div class="calendar-header">
      <button class="nav-btn" onclick="changeMonth(-1)">â—€ ì´ì „</button>
      <h2 id="current-month">2026ë…„ 1ì›”</h2>
      <button class="nav-btn" onclick="changeMonth(1)">ë‹¤ìŒ â–¶</button>
    </div>
    
    <div class="calendar-grid" id="calendar"></div>

    <div id="nickname-view">
      <div class="section-header">
        <h3 class="section-title" id="selected-date-text">ìˆ™ì œ ëŒ€ìƒì</h3>
        <button class="btn-add-show" onclick="toggleAddForm()">ìˆ™ì œ ì¶”ê°€í•˜ê¸°</button>
      </div>

      <div id="add-form">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">ë‚ ì§œ (ì´ë™ ê°€ëŠ¥ ğŸ“…)</label>
            <input type="date" id="new-date" class="form-input">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">ë‹‰ë„¤ì„</label>
            <input type="text" id="new-nick" class="form-input" placeholder="íŒ¬ë‹‰ë„¤ì„">
          </div>
          <div class="form-group">
            <label class="form-label">SOOP ì•„ì´ë””</label>
            <input type="text" id="new-id" class="form-input" placeholder="ì˜ë¬¸ID">
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">ì´í•© ê¸ˆì•¡</label>
            <input type="number" id="new-amount" class="form-input" placeholder="1000" oninput="autoCalculate()">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">ì—­íŒ¬ ê³„ì‚° ë¹„ìœ¨ (ì„ íƒ ğŸ¥•)</label>
            <div class="radio-group">
              <label class="radio-label">
                <input type="radio" name="calc-ratio" value="0.03" checked onchange="autoCalculate()"> 3%
              </label>
              <label class="radio-label">
                <input type="radio" name="calc-ratio" value="0.10" onchange="autoCalculate()"> 10%
              </label>
            </div>
            <input type="number" id="new-reverse" class="form-input" placeholder="ìë™ ê³„ì‚°ë¨" readonly>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">ìˆ™ì œ ë‚´ìš© (ì§ì ‘ ì…ë ¥ âœï¸)</label>
          <input type="text" id="new-content" class="form-input" placeholder="ì˜ˆ: ì •ì„±ë°©ì…€ + ì›€ì§¤ 1ê°œ">
        </div>
        
        <button class="btn-register" id="btn-submit" onclick="handleTaskSubmit()">ë“±ë¡ ì™„ë£Œ ğŸ’–</button>
      </div>

      <div class="nick-list" id="nick-list-container"></div>
    </div>

    <div id="detail-card">
      <div class="card-header">
        <div class="user-info">
          <h3 id="detail-nick">ë‹‰ë„¤ì„</h3>
          <span class="user-id" id="detail-id">id_placeholder</span>
        </div>
        <div>
          <button class="nav-btn edit-icon" onclick="openEditForm()" title="ë‚´ìš© ìˆ˜ì •í•˜ê¸°">âœï¸</button>
          <button class="nav-btn del-icon" onclick="deleteTask()" title="ì‚­ì œí•˜ê¸°">ğŸ—‘</button>
          <button class="nav-btn" onclick="closeDetail()">ë‹«ê¸° X</button>
        </div>
      </div>

      <div class="stat-grid">
        <div class="stat-box">
          <span class="stat-label">ì´ í›„ì› (í’)</span>
          <span class="stat-value money" id="detail-amount">0</span>
        </div>
        <div class="stat-box">
          <span class="stat-label">ì—­íŒ¬ (ê°œìˆ˜)</span>
          <span class="stat-value reverse" id="detail-reverse">0</span>
        </div>
      </div>

      <div class="task-box">
        <span class="task-label">ìˆ™ì œ ë‚´ìš©</span>
        <div class="task-content" id="detail-content">ë‚´ìš©</div>
        
        <div class="status-control">
          <span class="task-label">ì§„í–‰ ìƒíƒœ (í´ë¦­ ì‹œ ìë™ ì €ì¥ë¨!)</span>
          <div class="status-options">
            <input type="radio" name="status" id="st-todo" value="todo" class="status-radio" onchange="saveTaskStatus(false)">
            <label for="st-todo" class="status-label lbl-todo">ëŒ€ê¸° (ë¯¸ì™„)</label>

            <input type="radio" name="status" id="st-partial" value="partial" class="status-radio" onchange="saveTaskStatus(false)">
            <label for="st-partial" class="status-label lbl-partial">ë°©ì…€ë§Œ ì™„ë£Œ</label>

            <input type="radio" name="status" id="st-done" value="done" class="status-radio" onchange="saveTaskStatus(false)">
            <label for="st-done" class="status-label lbl-done">ì—­íŒ¬ê¹Œì§€ ì™„ë£Œ</label>
          </div>
          <textarea id="detail-memo" class="memo-input" placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì…ë ¥ í›„ ë°–ì„ í´ë¦­í•˜ë©´ ìë™ ì €ì¥)" onblur="saveTaskStatus(false)"></textarea>
        </div>
      </div>

      <div class="btn-group">
        <a href="#" target="_blank" class="btn-soop" id="detail-link">ğŸ“º SOOP ë°©ì†¡êµ­ ë°”ë¡œê°€ê¸°</a>
      </div>
      
      <button class="btn-complete" onclick="completeAndDelete()">ì™„ë£Œí•˜ê³  ëª©ë¡ì—ì„œ ì‚­ì œí•˜ê¸°</button>
    </div>
  </div>

  <div class="sidebar-right">
    <div class="sidebar-title">ğŸ¥• ëˆ„ì  ìˆ™ì œ ë­í‚¹</div>
    <div id="total-rank-list"></div>
  </div>

</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, set, onValue, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  // -----------------------------------------------------------------------------------------
  // ğŸ‘‡ ì—¬ê¸°ì— ì•„ê¹Œ ë³µì‚¬í•œ firebaseConfig ì½”ë“œë¥¼ ë®ì–´ì”Œìš°ì„¸ìš”! ğŸ‘‡
  // -----------------------------------------------------------------------------------------
  const firebaseConfig = {
    apiKey: "AIzaSyBhduAPQ_9IyEH1rnr9m9qtumgnIF90RII",
    authDomain: "homework-c9.firebaseapp.com",
    databaseURL: "https://homework-c9-default-rtdb.firebaseio.com",
    projectId: "homework-c9",
    storageBucket: "homework-c9.firebasestorage.app",
    messagingSenderId: "293416059203",
    appId: "1:293416059203:web:e962586275e2bd2b356ff6"
  };

  // -----------------------------------------------------------------------------------------

  // Firebase ì´ˆê¸°í™”
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const dbRef = ref(db, 'homework_data');

  let homeworkData = {}; // ì „ì—­ ë³€ìˆ˜
  window.homeworkData = homeworkData; // ìœˆë„ìš° ê°ì²´ì— í• ë‹¹í•˜ì—¬ ì¼ë°˜ í•¨ìˆ˜ì—ì„œë„ ì ‘ê·¼ ê°€ëŠ¥í•˜ê²Œ í•¨

  // --- ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ) ---
  onValue(dbRef, (snapshot) => {
    const data = snapshot.val();
    window.homeworkData = data || {}; // ë°ì´í„° ì—†ìœ¼ë©´ ë¹ˆ ê°ì²´
    homeworkData = window.homeworkData;

    // í™”ë©´ ê°±ì‹ 
    renderCalendar();
    renderSidebar();
    renderTotalRanking();
    
    // í˜„ì¬ ë³´ê³  ìˆëŠ” ìƒì„¸ ë·°ê°€ ìˆë‹¤ë©´ ê°±ì‹ 
    if(window.selectedDateKey) {
        renderNickList(window.homeworkData[window.selectedDateKey] || []);
    }
    
    // ë¡œë”© í™”ë©´ ì œê±°
    document.getElementById('loading-overlay').style.display = 'none';
  });

  // --- ë°ì´í„° ì €ì¥ í•¨ìˆ˜ (Firebaseìš©) ---
  window.saveToFirebase = function() {
    set(dbRef, window.homeworkData)
      .then(() => {
        // ì €ì¥ ì„±ê³µ (ë³„ë„ ì•Œë¦¼ ì—†ìŒ, ì‹¤ì‹œê°„ ë°˜ì˜ë¨)
      })
      .catch((error) => {
        alert("ë°ì´í„° ì €ì¥ ì‹¤íŒ¨: " + error.message);
      });
  }

  // ê¸°ì¡´ ë³€ìˆ˜ë“¤ window ê°ì²´ì— í• ë‹¹ (ëª¨ë“ˆ ìŠ¤ì½”í”„ íƒˆì¶œìš©)
  window.currentDate = new Date();
  window.selectedDateKey = null;
  window.currentTaskIndex = null;
  window.isEditMode = false;

  // ---------------------------------------------------------
  // ì•„ë˜ëŠ” ê¸°ì¡´ ë¡œì§ì„ Firebase ì €ì¥ ë°©ì‹(saveToFirebase)ìœ¼ë¡œ ë³€ê²½í•œ í•¨ìˆ˜ë“¤ì…ë‹ˆë‹¤.
  // ---------------------------------------------------------

  window.renderSidebar = function() {
    const sidebarList = document.getElementById('sidebar-list');
    sidebarList.innerHTML = '';
    const sortedKeys = Object.keys(window.homeworkData).sort().reverse();
    const validKeys = sortedKeys.filter(key => window.homeworkData[key] && window.homeworkData[key].length > 0);

    if (validKeys.length === 0) {
      sidebarList.innerHTML = `<div class="no-data-msg">ì•„ì§ ìˆ™ì œê°€ ì—†ì–´ìš” ê¹¡ì´! ğŸ‡</div>`;
      return;
    }

    validKeys.forEach(dateKey => {
      const tasks = window.homeworkData[dateKey];
      const btn = document.createElement('div');
      btn.className = 'shortcut-btn';
      btn.innerHTML = `<span class="shortcut-date">${dateKey}</span><span class="shortcut-count">${tasks.length}ê±´</span>`;
      btn.onclick = () => {
        window.currentDate = new Date(dateKey);
        window.renderCalendar();
        window.selectDate(dateKey);
      };
      sidebarList.appendChild(btn);
    });
  }

  window.renderTotalRanking = function() {
    const rankListEl = document.getElementById('total-rank-list');
    rankListEl.innerHTML = '';
    const userCounts = {};
    
    Object.keys(window.homeworkData).forEach(date => {
      const tasks = window.homeworkData[date];
      tasks.forEach(task => {
        if (!userCounts[task.id]) {
          userCounts[task.id] = { nick: task.nick, id: task.id, count: 0 };
        }
        userCounts[task.id].count++;
      });
    });

    const sortedUsers = Object.values(userCounts).sort((a, b) => b.count - a.count);

    if (sortedUsers.length === 0) {
      rankListEl.innerHTML = `<div class="no-data-msg">ì§‘ê³„ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
      return;
    }

    sortedUsers.forEach((user, index) => {
      const item = document.createElement('div');
      item.className = 'rank-item';
      
      let icon = '';
      if(index === 0) icon = 'ğŸ‘‘ ';
      else if(index === 1) icon = 'ğŸ¥ˆ ';
      else if(index === 2) icon = 'ğŸ¥‰ ';
      else icon = `${index + 1}. `;

      item.innerHTML = `
        <div class="rank-info">
          <span class="rank-nick"><span class="rank-icon">${icon}</span>${user.nick}</span>
          <span class="rank-id">(${user.id})</span>
        </div>
        <div class="rank-badge">${user.count}ê°œ</div>
      `;
      rankListEl.appendChild(item);
    });
  }

  window.renderCalendar = function() {
    const year = window.currentDate.getFullYear();
    const month = window.currentDate.getMonth();
    document.getElementById('current-month').innerText = `${year}ë…„ ${month + 1}ì›”`;
    const calendarEl = document.getElementById('calendar');
    calendarEl.innerHTML = '';
    
    document.getElementById('nickname-view').style.display = 'none';
    document.getElementById('detail-card').style.display = 'none';
    document.getElementById('add-form').style.display = 'none';

    ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].forEach(d => calendarEl.innerHTML += `<div class="day-name">${d}</div>`);

    const firstDay = new Date(year, month, 1).getDay();
    const lastDate = new Date(year, month + 1, 0).getDate();

    for(let i=0; i<firstDay; i++) calendarEl.innerHTML += `<div></div>`;

    for(let i=1; i<=lastDate; i++) {
      const dateKey = `${year}-${String(month+1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
      const tasks = window.homeworkData[dateKey] || [];
      const hasTask = tasks.length > 0;
      calendarEl.innerHTML += `
        <div class="day-cell ${hasTask ? 'has-homework' : ''}" onclick="selectDate('${dateKey}')">
          <div class="day-number">${i}</div>
          ${hasTask ? `<div class="hw-badge">${tasks.length}ê±´</div>` : ''}
        </div>
      `;
    }
  }

  window.changeMonth = function(step) {
    window.currentDate.setMonth(window.currentDate.getMonth() + step);
    window.renderCalendar();
  }

  window.selectDate = function(dateKey) {
    window.selectedDateKey = dateKey;
    const tasks = window.homeworkData[dateKey] || [];
    document.getElementById('detail-card').style.display = 'none';
    document.getElementById('add-form').style.display = 'none';
    document.getElementById('selected-date-text').innerText = `${dateKey} ìˆ™ì œ ë¦¬ìŠ¤íŠ¸`;
    window.renderNickList(tasks);
    document.getElementById('nickname-view').style.display = 'block';
    if(window.innerWidth <= 1024) {
      document.getElementById('nickname-view').scrollIntoView({ behavior: 'smooth' });
    }
  }

  window.renderNickList = function(tasks) {
    const nickList = document.getElementById('nick-list-container');
    nickList.innerHTML = '';
    if (tasks.length === 0) {
      nickList.innerHTML = `<div style="grid-column: span 3; text-align:center; color:#aaa; padding: 20px; font-size:14px; font-style:italic;">ì´ ë‚ ì€ ìˆ™ì œê°€ ì—†ì–´ìš”! ğŸ¥•</div>`;
      return;
    }
    tasks.forEach((task, index) => {
      const btn = document.createElement('button');
      let statusClass = 'status-todo';
      if(task.status === 'partial') statusClass = 'status-partial';
      if(task.status === 'done') statusClass = 'status-done';
      
      btn.className = `nick-btn ${statusClass}`;
      btn.innerText = task.nick;
      btn.onclick = () => {
        document.querySelectorAll('.nick-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        window.showMemberDetail(task, index);
      };
      nickList.appendChild(btn);
    });
  }

  window.toggleAddForm = function() {
    window.isEditMode = false;
    const form = document.getElementById('add-form');
    document.getElementById('new-date').value = window.selectedDateKey || '';
    document.getElementById('new-nick').value = '';
    document.getElementById('new-id').value = '';
    document.getElementById('new-amount').value = '';
    document.getElementById('new-reverse').value = '';
    document.getElementById('new-content').value = '';
    
    const submitBtn = document.getElementById('btn-submit');
    submitBtn.innerText = "ë“±ë¡ ì™„ë£Œ ğŸ’–";
    submitBtn.classList.remove('edit-mode');

    form.style.display = 'block';
    document.getElementById('new-nick').focus();
    form.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }

  window.openEditForm = function() {
    if (!window.selectedDateKey || window.currentTaskIndex === null) return;
    
    window.isEditMode = true;
    const task = window.homeworkData[window.selectedDateKey][window.currentTaskIndex];
    
    document.getElementById('new-date').value = window.selectedDateKey;
    document.getElementById('new-nick').value = task.nick;
    document.getElementById('new-id').value = task.id;
    document.getElementById('new-amount').value = task.amount;
    document.getElementById('new-reverse').value = task.reverse;
    document.getElementById('new-content').value = task.content;

    const ratio = (task.amount > 0) ? (task.reverse / task.amount) : 0.03;
    if(ratio >= 0.09) { 
        document.querySelector('input[name="calc-ratio"][value="0.10"]').checked = true;
    } else {
        document.querySelector('input[name="calc-ratio"][value="0.03"]').checked = true;
    }

    const submitBtn = document.getElementById('btn-submit');
    submitBtn.innerText = "ìˆ˜ì • ì™„ë£Œ ğŸ”„";
    submitBtn.classList.add('edit-mode');

    document.getElementById('detail-card').style.display = 'none';
    document.getElementById('add-form').style.display = 'block';
    document.getElementById('add-form').scrollIntoView({ behavior: 'smooth', block: 'center' });
  }

  window.autoCalculate = function() {
    const amount = parseInt(document.getElementById('new-amount').value) || 0;
    const reverseInput = document.getElementById('new-reverse');
    const ratio = parseFloat(document.querySelector('input[name="calc-ratio"]:checked').value);
    const reverse = Math.floor(amount * ratio);
    reverseInput.value = reverse;
  }

  window.handleTaskSubmit = function() {
    const newDateKey = document.getElementById('new-date').value;
    if(!newDateKey) return alert("ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!");

    const nick = document.getElementById('new-nick').value;
    const id = document.getElementById('new-id').value;
    const amount = parseInt(document.getElementById('new-amount').value) || 0;
    const reverse = parseInt(document.getElementById('new-reverse').value) || 0;
    const content = document.getElementById('new-content').value;

    if(!nick || !id) return alert("ë‹‰ë„¤ì„ê³¼ ì•„ì´ë””ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”! âœï¸");

    const newTaskObj = {
      nick: nick,
      id: id,
      amount: amount,
      reverse: reverse,
      content: content,
      status: "todo",
      memo: ""
    };

    if (window.isEditMode) {
      const oldTask = window.homeworkData[window.selectedDateKey][window.currentTaskIndex];
      newTaskObj.status = oldTask.status;
      newTaskObj.memo = oldTask.memo;

      if (newDateKey === window.selectedDateKey) {
          window.homeworkData[window.selectedDateKey][window.currentTaskIndex] = newTaskObj;
          alert("ìˆ™ì œ ë‚´ìš©ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“");
      } else {
          window.homeworkData[window.selectedDateKey].splice(window.currentTaskIndex, 1);
          if(!window.homeworkData[newDateKey]) window.homeworkData[newDateKey] = [];
          window.homeworkData[newDateKey].push(newTaskObj);
          alert(`ìˆ™ì œê°€ ${newDateKey}ë¡œ ì´ë™ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸšš`);
      }
      window.isEditMode = false;
    } else {
      if(!window.homeworkData[newDateKey]) window.homeworkData[newDateKey] = [];
      window.homeworkData[newDateKey].push(newTaskObj);
    }

    window.saveToFirebase(); // Firebase ì €ì¥ í˜¸ì¶œ
    document.getElementById('add-form').style.display = 'none';
    
    // selectedDateKeyê°€ ìˆìœ¼ë©´ ê°±ì‹ , ì—†ìœ¼ë©´ ìº˜ë¦°ë” ë¦¬ë Œë”ë§ë§Œ
    if(window.selectedDateKey) {
       window.selectDate(window.selectedDateKey);
    } else {
       window.renderCalendar();
    }
  }

  window.showMemberDetail = function(task, index) {
    window.currentTaskIndex = index;
    const card = document.getElementById('detail-card');
    
    document.getElementById('detail-nick').innerText = task.nick;
    document.getElementById('detail-id').innerText = `@${task.id}`;
    document.getElementById('detail-amount').innerText = task.amount.toLocaleString();
    document.getElementById('detail-reverse').innerText = task.reverse.toLocaleString();
    document.getElementById('detail-content').innerText = task.content; 
    document.getElementById('detail-memo').value = task.memo || '';
    
    const status = task.status || 'todo';
    document.querySelector(`input[name="status"][value="${status}"]`).checked = true;

    document.getElementById('detail-link').href = `https://www.sooplive.co.kr/station/${task.id}`;
    
    card.style.display = 'block';
    card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }

  window.saveTaskStatus = function(showMsg = false) {
    if (!window.selectedDateKey || window.currentTaskIndex === null) return;
    const newMemo = document.getElementById('detail-memo').value;
    const newStatus = document.querySelector('input[name="status"]:checked').value;
    const task = window.homeworkData[window.selectedDateKey][window.currentTaskIndex];
    
    // ë³€ê²½ì‚¬í•­ ì—†ìœ¼ë©´ ë¦¬í„´ (ë¶ˆí•„ìš”í•œ ì“°ê¸° ë°©ì§€)
    if(task.memo === newMemo && task.status === newStatus) return;

    task.memo = newMemo;
    task.status = newStatus;

    window.saveToFirebase();
    if(showMsg) alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! âœ¨');
    
    window.renderNickList(window.homeworkData[window.selectedDateKey]);
    const btns = document.querySelectorAll('.nick-btn');
    if(btns[window.currentTaskIndex]) btns[window.currentTaskIndex].classList.add('active');
  }

  window.completeAndDelete = function() {
    if (!confirm('ğŸ‰ ìˆ™ì œë¥¼ ì™„ë£Œí•˜ê³  ëª©ë¡ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    window.homeworkData[window.selectedDateKey].splice(window.currentTaskIndex, 1);
    window.saveToFirebase();
    window.closeDetail();
  }

  window.deleteTask = function() {
      if (!confirm('ì •ë§ ì´ ìˆ™ì œë¥¼ ë¦¬ìŠ¤íŠ¸ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤) ğŸ˜¥')) return;
      window.homeworkData[window.selectedDateKey].splice(window.currentTaskIndex, 1);
      window.saveToFirebase();
      window.closeDetail();
  }

  window.closeDetail = function() {
    document.getElementById('detail-card').style.display = 'none';
    document.querySelectorAll('.nick-btn').forEach(b => b.classList.remove('active'));
    window.currentTaskIndex = null;
    document.getElementById('add-form').style.display = 'none';
  }
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>C9 í† ë¼ ìˆ™ì œ & ë‚­í”Œë‹¨ ê¸°ë¡ì‹¤ ğŸ°</title>
<style>
  /* --- ğŸ° ë””ìì¸ ë³€ìˆ˜ ì„ ì–¸ --- */
  :root {
    --bg-color: #FFF6FA;
    --container-bg: #ffffff;
    --primary-pink: #FF8FB2; 
    --dark-pink: #D04F7D; 
    --light-pink-hover: #FFF9FD;
    --border-pink: #FFE1EF; 
    --text-gray: #4c2d3b;
    --text-dark: #333;
    --accent-blue: #aed9e0; 
    --shadow-color: rgba(255, 150, 180, 0.15);
    --radius-soft: 15px;
    --radius-round: 24px;

    /* ê¸ˆì•¡ë³„ ë°°ê²½ìƒ‰ ë‹¨ê³„ (ìš”ì²­í•˜ì‹  ë””ìì¸) */
    --lv0: #FFFFFF;
    --lv1: #FFF9FD;
    --lv2: #FFF3FA;
    --lv3: #FFE9F4;
    --lv4: #FFE0EF;
    --lv5: #FFD7EB;
    --lv6: #FFCEE7;
    --lv7: #FFC6E3;
    --lv8: #FFBEDF;
    --lv9: #FFB6DA;
  }

  /* --- ê³µí†µ ìŠ¤íƒ€ì¼ --- */
  body { 
    font-family: "Pretendard", -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
    background-color: var(--bg-color);
    padding: 20px; margin: 0; color: var(--text-gray);
  }
  input, button, textarea, select { font-family: inherit; box-sizing: border-box; outline: none; }
  h2, h3 { color: var(--primary-pink); font-weight: 800; text-align: center; }

  /* ë„¤ë¹„ê²Œì´ì…˜ íƒ­ */
  .main-nav { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
  .nav-tab {
    padding: 10px 24px; border-radius: 999px; font-weight: bold; font-size: 15px;
    background: #FFD6EA; border: none; color: #C04270;
    cursor: pointer; transition: 0.2s;
  }
  .nav-tab:hover { background: #ffbfdc; }
  .nav-tab.active { background: #FF8FB2; color: white; box-shadow: 0 4px 10px var(--shadow-color); }

  .page-section { display: none; animation: fadeIn 0.3s; }
  .page-section.active { display: block; }

  /* --------------------------------------------------------
     [í˜ì´ì§€ 1] ìº˜ë¦°ë” ìŠ¤íƒ€ì¼ (ê¸°ì¡´ ìœ ì§€) 
     -------------------------------------------------------- */
  .wrapper { display: flex; gap: 20px; max-width: 1400px; margin: 0 auto; align-items: flex-start; }
  .sidebar, .sidebar-right { width: 260px; background: var(--container-bg); padding: 25px; border-radius: var(--radius-round); box-shadow: 0 4px 12px var(--shadow-color); flex-shrink: 0; max-height: 800px; overflow-y: auto; }
  .container { flex: 1; background: var(--container-bg); padding: 30px; border-radius: var(--radius-round); box-shadow: 0 4px 12px var(--shadow-color); position: relative; }
  
  /* ìº˜ë¦°ë” ê·¸ë¦¬ë“œ ë“± ê¸°ì¡´ ìŠ¤íƒ€ì¼ */
  .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
  .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-bottom: 20px;}
  .day-cell { height: 70px; background: #fff; border: 1px solid var(--border-pink); border-radius: 12px; position: relative; cursor: pointer; padding: 5px; }
  .day-cell:hover { background: var(--light-pink-hover); border-color: var(--primary-pink); }
  .has-homework { background-color: #FFF0F5 !important; border: 1px solid #FFB6DA !important; }
  .hw-badge { position: absolute; bottom: 5px; right: 5px; background: var(--dark-pink); color: white; font-size: 10px; padding: 2px 6px; border-radius: 8px; }
  
  /* ì‚¬ì´ë“œë°” ë¦¬ìŠ¤íŠ¸ */
  .shortcut-btn { width: 100%; padding: 10px; border: 1px solid var(--border-pink); background: white; border-radius: 12px; margin-bottom: 5px; cursor: pointer; display: flex; justify-content: space-between; }
  .shortcut-btn:hover { background: var(--light-pink-hover); }
  
  /* ë‹‰ë„¤ì„ ë·° & í¼ */
  #nickname-view { display: none; margin-top: 20px; border-top: 2px dashed var(--border-pink); padding-top: 20px; }
  .nick-list { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
  .nick-btn { padding: 12px; border: 1px solid var(--border-pink); background: white; border-radius: 12px; cursor: pointer; font-weight: bold; color: var(--text-gray); }
  .nick-btn.active { background: var(--light-pink-hover); border-color: var(--primary-pink); color: var(--dark-pink); }
  
  #add-form { display: none; background: #FFF9FD; padding: 15px; border-radius: 15px; margin-bottom: 15px; border: 1px solid var(--border-pink); }
  .form-row { display: flex; gap: 10px; margin-bottom: 10px; }
  .form-input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 8px; }
  .btn-register { width: 100%; padding: 10px; background: var(--primary-pink); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }

  /* ìƒì„¸ ì¹´ë“œ */
  #detail-card { display: none; margin-top: 20px; background: #FFF9FD; padding: 20px; border-radius: 15px; border: 1px solid var(--border-pink); }
  .btn-soop { display: block; width: 100%; padding: 10px; background: #AED9E0; color: white; text-align: center; border-radius: 8px; text-decoration: none; margin-top: 10px; font-weight: bold; }
  .btn-complete { width: 100%; padding: 10px; background: var(--dark-pink); color: white; border: none; border-radius: 8px; margin-top: 10px; cursor: pointer; font-weight: bold; }

  /* --------------------------------------------------------
     [í˜ì´ì§€ 2] ë‚­í”Œë‹¨ ê¸°ë¡ì‹¤ (ìš”ì²­í•˜ì‹  ë””ìì¸ ë°˜ì˜) 
     -------------------------------------------------------- */
  .record-layout {
    max-width: 1100px; margin: 0 auto;
  }
  
  /* ì‹œì¦Œ íƒ­ ìŠ¤íƒ€ì¼ */
  .season-tabs { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 15px; border-bottom: 1px solid var(--border-pink); }
  .season-tab-btn {
    padding: 8px 16px; border-radius: 99px; background: white; border: 1px solid var(--border-pink); color: var(--text-gray); cursor: pointer; font-size: 13px; white-space: nowrap;
  }
  .season-tab-btn.active { background: var(--dark-pink); color: white; border-color: var(--dark-pink); font-weight: bold; }
  
  .record-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
  .paste-guide { font-size: 12px; color: #888; background: #fff; padding: 5px 10px; border-radius: 8px; border: 1px solid #eee; }

  /* í…Œì´ë¸” êµ¬ì¡° (Flex) */
  .record-table { display: flex; flex-direction: column; gap: 6px; min-width: 700px; }
  
  .row {
    display: flex; background: white; border-radius: 24px; overflow: hidden;
    box-shadow: 0 1px 4px rgba(255,150,180,0.08); padding: 4px 0; align-items: center;
    transition: 0.15s;
  }
  .row:hover { transform: translateY(-1px); box-shadow: 0 3px 8px rgba(255,150,180,0.15); }
  
  .header-row { background: #FFEFF7; border-radius: 24px; margin-bottom: 4px; box-shadow: none; pointer-events: none; }
  .header-row .cell { font-weight: 700; color: var(--dark-pink); border-bottom: 2px solid #F8C7DB; }
  
  .summary-row { background: #FFF9FD; font-weight: 700; color: var(--dark-pink); margin-top: 10px; }

  /* ì…€ ìŠ¤íƒ€ì¼ */
  .cell {
    padding: 6px 10px; font-size: 14px; text-align: center;
    border-right: 1px solid #FFE1EF; outline: none; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .cell:last-child { border-right: none; }
  .cell.editable { cursor: text; }
  .cell.editable:focus { background: #fff; box-shadow: 0 0 0 2px var(--primary-pink) inset; border-radius: 4px; }

  /* ì—´ ë„ˆë¹„ ì„¤ì • */
  .col-id { width: 15%; }
  .col-nick { width: 15%; }
  .col-amt { width: 12%; font-weight: bold; color: var(--dark-pink); }
  .col-one { width: 8%; }
  .col-promise { width: 40%; text-align: left; white-space: normal; }
  .col-action { width: 10%; position: relative; }

  /* ì‚­ì œ ë²„íŠ¼ (í˜¸ë²„ ì‹œ í‘œì‹œ) */
  .del-btn {
    display: none; background: #FFD8EA; border: none; border-radius: 99px;
    padding: 4px 10px; font-size: 11px; color: var(--dark-pink); cursor: pointer;
  }
  .row:hover .del-btn { display: inline-block; }
  .del-btn:hover { background: #ffbddc; }

  @media (max-width: 1024px) {
    .wrapper { flex-direction: column; }
    .sidebar, .sidebar-right { width: 100%; max-height: 200px; }
    .record-table { min-width: 100%; overflow-x: scroll; }
  }
  
  #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); display: flex; justify-content: center; align-items: center; z-index: 9999; font-weight: bold; color: var(--primary-pink); font-size: 1.2rem; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>
</head>
<body>

<div id="loading-overlay">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘... ğŸ¥•</div>

<nav class="main-nav">
  <button class="nav-tab active" onclick="switchPage('calendar')">ğŸ“… ìˆ™ì œ ìº˜ë¦°ë”</button>
  <button class="nav-tab" onclick="switchPage('record')">ğŸ† ë‚­í”Œë‹¨ ê¸°ë¡ì‹¤</button>
</nav>

<div id="page-calendar" class="page-section active">
  <div class="wrapper">
    <div class="sidebar">
      <h3 style="margin-top:0; font-size:16px;">ğŸ° ë‚ ì§œë³„ ê¸°ë¡</h3>
      <div id="sidebar-list"></div>
    </div>

    <div class="container">
      <div class="calendar-header">
        <button onclick="changeMonth(-1)">â—€</button>
        <h2 id="current-month" style="margin:0;">2026ë…„ 1ì›”</h2>
        <button onclick="changeMonth(1)">â–¶</button>
      </div>
      <div class="calendar-grid" id="calendar"></div>

      <div id="nickname-view">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <span style="font-weight:bold; color:var(--dark-pink);">ìˆ™ì œ ë¦¬ìŠ¤íŠ¸</span>
          <button class="nav-tab" style="padding:6px 12px; font-size:12px;" onclick="toggleAddForm()">+ ì¶”ê°€</button>
        </div>

        <div id="add-form">
          <div class="form-row">
            <input type="date" id="new-date" class="form-input">
          </div>
          <div class="form-row">
            <input type="text" id="new-nick" class="form-input" placeholder="ë‹‰ë„¤ì„">
            <input type="text" id="new-id" class="form-input" placeholder="ì•„ì´ë””">
          </div>
          <div class="form-row">
            <input type="number" id="new-amount" class="form-input" placeholder="í’ì„  ê°œìˆ˜" oninput="autoCalculate()">
            <input type="number" id="new-reverse" class="form-input" placeholder="ì—­íŒ¬(ìë™)" readonly>
          </div>
          <input type="text" id="new-content" class="form-input" placeholder="ìˆ™ì œ ë‚´ìš©" style="margin-bottom:10px;">
          <button class="btn-register" id="btn-submit" onclick="handleTaskSubmit()">ë“±ë¡í•˜ê¸°</button>
        </div>

        <div class="nick-list" id="nick-list-container"></div>
      </div>

      <div id="detail-card">
        <div style="display:flex; justify-content:space-between;">
          <h3 id="detail-nick" style="margin:0;">ë‹‰ë„¤ì„</h3>
          <button onclick="closeDetail()" style="border:none; background:none; cursor:pointer;">âŒ</button>
        </div>
        <p id="detail-id" style="color:#888; font-size:12px; margin-bottom:15px;"></p>
        
        <div style="background:white; padding:10px; border-radius:8px; margin-bottom:10px;">
          <div>ğŸ’° <span id="detail-amount">0</span>ê°œ</div>
          <div>ğŸ ì—­íŒ¬ <span id="detail-reverse">0</span>ê°œ</div>
        </div>
        <div style="background:white; padding:10px; border-radius:8px; margin-bottom:10px;">
          <div style="font-weight:bold; margin-bottom:5px;">ğŸ“ ë‚´ìš©</div>
          <div id="detail-content"></div>
        </div>
        <textarea id="detail-memo" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px;" placeholder="ë©”ëª¨ (ìë™ì €ì¥)" onblur="saveTaskStatus()"></textarea>
        
        <div style="display:flex; gap:5px; margin-top:10px;">
          <button class="nav-tab" onclick="openEditForm()">ìˆ˜ì •</button>
          <button class="nav-tab" style="background:#ff8a80; color:white;" onclick="deleteTask()">ì‚­ì œ</button>
        </div>
        <a href="#" id="detail-link" target="_blank" class="btn-soop">ë°©ì†¡êµ­ ê°€ê¸°</a>
        <button class="btn-complete" onclick="completeAndDelete()">ì™„ë£Œ ì²˜ë¦¬ (ì‚­ì œ)</button>
      </div>
    </div>
  </div>
</div>

<div id="page-record" class="page-section">
  <div class="record-layout">
    <h2 style="margin-bottom:20px;">ğŸ† ë‚­í”Œë‹¨ ëª…ì˜ˆì˜ ì „ë‹¹</h2>
    
    <div class="record-controls">
      <button class="nav-tab" style="font-size:12px; padding:8px 16px;" onclick="createNewSeason()">+ ìƒˆ ì‹œì¦Œ/íšŒì°¨ ì¶”ê°€</button>
      <span class="paste-guide">ğŸ’¡ Tip: ì—‘ì…€ì—ì„œ ë³µì‚¬(Ctrl+C)í•œ ë‚´ìš©ì„ ì•„ë¬´ ê³³ì—ë‚˜ ë¶™ì—¬ë„£ê¸°(Ctrl+V) í•˜ì„¸ìš”!</span>
    </div>

    <div class="season-tabs" id="season-tabs-container"></div>

    <div id="season-content-area" style="display:none;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h3 id="current-season-title" style="margin:0; font-size:18px;"></h3>
        <button onclick="deleteCurrentSeason()" style="font-size:11px; color:#ff5252; border:1px solid #ff5252; background:none; border-radius:6px; padding:4px 8px; cursor:pointer;">ì´ ì‹œì¦Œ ì‚­ì œ</button>
      </div>

      <div class="record-table">
        <div class="row header-row">
          <div class="cell col-id">ì•„ì´ë””</div>
          <div class="cell col-nick">ë‹‰ë„¤ì„</div>
          <div class="cell col-amt">ë‚­í”Œ</div>
          <div class="cell col-one">1+1</div>
          <div class="cell col-promise">ê³µì•½</div>
          <div class="cell col-action"></div>
        </div>

        <div id="record-data-rows"></div>

        <div class="row summary-row">
          <div class="cell col-id">í•©ê³„</div>
          <div class="cell col-nick"></div>
          <div class="cell col-amt" id="season-total-sum">0</div>
          <div class="cell col-one"></div>
          <div class="cell col-promise"></div>
          <div class="cell col-action"></div>
        </div>
      </div>
      
      <div style="text-align:center; margin-top:20px;">
        <button class="nav-tab" onclick="addEmptyRow()">+ ë¹ˆ ì¤„ ì¶”ê°€</button>
      </div>
    </div>

    <div id="no-season-msg" style="text-align:center; padding:50px; color:#aaa;">
      ë“±ë¡ëœ íšŒì°¨ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒë‹¨ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¶”ê°€í•´ì£¼ì„¸ìš”!
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBhduAPQ_9IyEH1rnr9m9qtumgnIF90RII",
    authDomain: "homework-c9.firebaseapp.com",
    databaseURL: "https://homework-c9-default-rtdb.firebaseio.com",
    projectId: "homework-c9",
    storageBucket: "homework-c9.firebasestorage.app",
    messagingSenderId: "293416059203",
    appId: "1:293416059203:web:e962586275e2bd2b356ff6"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  
  const dbRefHome = ref(db, 'homework_data');
  const dbRefSeason = ref(db, 'season_data');

  window.homeworkData = {}; 
  window.seasonData = {};
  window.currentSeasonName = null;

  // ë°ì´í„° ë¡œë“œ
  onValue(dbRefHome, (snapshot) => {
    window.homeworkData = snapshot.val() || {};
    refreshCalendarUI();
    document.getElementById('loading-overlay').style.display = 'none';
  });

  onValue(dbRefSeason, (snapshot) => {
    window.seasonData = snapshot.val() || {};
    renderSeasonTabs();
    if(window.currentSeasonName && window.seasonData[window.currentSeasonName]) {
        renderRecordTable(window.currentSeasonName);
    } else {
        const keys = Object.keys(window.seasonData).sort();
        if(keys.length > 0) switchSeasonTab(keys[0]);
        else {
            document.getElementById('season-content-area').style.display = 'none';
            document.getElementById('no-season-msg').style.display = 'block';
        }
    }
  });

  window.saveHomework = () => set(dbRefHome, window.homeworkData);
  window.saveSeason = () => set(dbRefSeason, window.seasonData);

  // --- [íƒ­ ì „í™˜] ---
  window.switchPage = (page) => {
    document.querySelectorAll('.page-section').forEach(e => e.classList.remove('active'));
    document.querySelectorAll('.main-nav .nav-tab').forEach(e => e.classList.remove('active'));
    document.getElementById(`page-${page}`).classList.add('active');
    
    // ë²„íŠ¼ í™œì„±í™”
    const tabs = document.querySelectorAll('.main-nav .nav-tab');
    if(page==='calendar') tabs[0].classList.add('active');
    else tabs[1].classList.add('active');
  };

  // =================================================================
  // [ê¸°ë¡ì‹¤] ì—‘ì…€ ë¶™ì—¬ë„£ê¸° & í…Œì´ë¸” ë¡œì§
  // =================================================================
  
  // 1. ì‹œì¦Œ ì¶”ê°€
  window.createNewSeason = () => {
    const name = prompt("ìƒˆ ì‹œì¦Œ/íšŒì°¨ ì´ë¦„ (ì˜ˆ: 1íšŒì°¨, ê²½ìŸì „)");
    if(!name) return;
    if(window.seasonData[name]) return alert("ì´ë¯¸ ìˆìŠµë‹ˆë‹¤.");
    window.seasonData[name] = [];
    window.saveSeason();
    window.switchSeasonTab(name);
  };

  // 2. íƒ­ ë Œë”ë§
  window.renderSeasonTabs = () => {
    const container = document.getElementById('season-tabs-container');
    container.innerHTML = '';
    const keys = Object.keys(window.seasonData).sort();
    
    if(keys.length === 0) return;
    document.getElementById('no-season-msg').style.display = 'none';

    keys.forEach(key => {
        const btn = document.createElement('button');
        btn.className = `season-tab-btn ${key === window.currentSeasonName ? 'active' : ''}`;
        btn.innerText = key;
        btn.onclick = () => window.switchSeasonTab(key);
        container.appendChild(btn);
    });
  };

  window.switchSeasonTab = (name) => {
    window.currentSeasonName = name;
    renderSeasonTabs();
    renderRecordTable(name);
    document.getElementById('season-content-area').style.display = 'block';
  };

  // 3. í…Œì´ë¸” ë Œë”ë§ (ìš”ì²­í•˜ì‹  ë””ìì¸)
  window.renderRecordTable = (seasonName) => {
    document.getElementById('current-season-title').innerText = seasonName;
    const container = document.getElementById('record-data-rows');
    container.innerHTML = '';
    
    const list = window.seasonData[seasonName] || [];
    let totalSum = 0;

    list.forEach((item, index) => {
        const amt = parseInt(item.amount || 0);
        totalSum += amt;

        // ìƒ‰ìƒ ë ˆë²¨ ê²°ì •
        let lv = "--lv0";
        if(amt>=300000) lv="--lv9";
        else if(amt>=100000) lv="--lv8";
        else if(amt>=50000) lv="--lv7";
        else if(amt>=10000) lv="--lv6";
        else if(amt>=5000) lv="--lv5";
        else if(amt>=3000) lv="--lv4";
        else if(amt>=1000) lv="--lv3";
        else if(amt>=500) lv="--lv2";
        else if(amt>=100) lv="--lv1";

        const row = document.createElement('div');
        row.className = 'row';
        row.style.background = `var(${lv})`;
        
        row.innerHTML = `
            <div class="cell col-id editable" contenteditable="true" onblur="updateRecord('${seasonName}', ${index}, 'id', this)">${item.id || ''}</div>
            <div class="cell col-nick editable" contenteditable="true" onblur="updateRecord('${seasonName}', ${index}, 'nick', this)">${item.nick || ''}</div>
            <div class="cell col-amt editable" contenteditable="true" onblur="updateRecord('${seasonName}', ${index}, 'amount', this)">${item.amount || ''}</div>
            <div class="cell col-one editable" contenteditable="true" onblur="updateRecord('${seasonName}', ${index}, 'oneplus', this)">${item.oneplus || ''}</div>
            <div class="cell col-promise editable" contenteditable="true" onblur="updateRecord('${seasonName}', ${index}, 'promise', this)">${item.promise || ''}</div>
            <div class="cell col-action">
                <button class="del-btn" onclick="deleteRecord('${seasonName}', ${index})">ğŸ—‘</button>
            </div>
        `;
        container.appendChild(row);
    });

    document.getElementById('season-total-sum').innerText = totalSum.toLocaleString();
  };

  // 4. ë°ì´í„° ìˆ˜ì • (contenteditable)
  window.updateRecord = (seasonName, index, field, element) => {
    let val = element.innerText.trim();
    if(field === 'amount') val = val.replace(/[^0-9]/g, ''); // ìˆ«ìê°€ ì•„ë‹Œê±° ì œê±°
    
    // ë°ì´í„° ê°±ì‹ 
    if(!window.seasonData[seasonName][index]) return;
    window.seasonData[seasonName][index][field] = val;
    
    // ì €ì¥ ë° ê°±ì‹  (ìƒ‰ìƒ/í•©ê³„ ë°˜ì˜ì„ ìœ„í•´)
    window.saveSeason();
    // ì „ì²´ ë¦¬ë Œë”ë§ë³´ë‹¤ëŠ” UXìƒ ì‚´ì§ ë”œë ˆì´ í›„ ì €ì¥ì´ ì¢‹ìœ¼ë‚˜, ì—¬ê¸°ì„  ë‹¨ìˆœí™”
    // renderRecordTable(seasonName); // í¬ì»¤ìŠ¤ ìƒëŠ” ë¬¸ì œ ë°©ì§€ë¥¼ ìœ„í•´ ë¦¬ë Œë”ë§ì€ ìƒëµí•˜ê³  ê°’ë§Œ ì €ì¥.
    // í•˜ì§€ë§Œ í•©ê³„ ê°±ì‹ ì´ í•„ìš”í•˜ë¯€ë¡œ ìˆ˜ë™ ê³„ì‚° ì—…ë°ì´íŠ¸
    updateSummaryOnly(seasonName);
  };

  function updateSummaryOnly(seasonName) {
      // í•©ê³„ë§Œ ë‹¤ì‹œ ê³„ì‚°í•´ì„œ ì°ì–´ì¤Œ
      let sum = 0;
      window.seasonData[seasonName].forEach(i => sum += parseInt(i.amount||0));
      document.getElementById('season-total-sum').innerText = sum.toLocaleString();
  }

  // 5. ë¹ˆ ì¤„ ì¶”ê°€
  window.addEmptyRow = () => {
    if(!window.currentSeasonName) return;
    window.seasonData[window.currentSeasonName].push({ id:'', nick:'', amount:'', oneplus:'', promise:'' });
    window.saveSeason();
  };

  // 6. ì‚­ì œ
  window.deleteRecord = (seasonName, index) => {
    if(!confirm("ì‚­ì œí•©ë‹ˆê¹Œ?")) return;
    window.seasonData[seasonName].splice(index, 1);
    window.saveSeason();
  };

  window.deleteCurrentSeason = () => {
    if(!confirm("ì´ íšŒì°¨ íƒ­ì„ ì™„ì „íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    delete window.seasonData[window.currentSeasonName];
    window.currentSeasonName = null;
    window.saveSeason();
  };

  // â˜…â˜…â˜… [í•µì‹¬] ì—‘ì…€ ë¶™ì—¬ë„£ê¸° ê¸°ëŠ¥ â˜…â˜…â˜…
  document.addEventListener('paste', (e) => {
    // 1. í˜„ì¬ íƒ­ì´ 'record'ì¸ì§€ í™•ì¸
    if(!document.getElementById('page-record').classList.contains('active')) return;
    if(!window.currentSeasonName) return;

    // 2. ë¶™ì—¬ë„£ê¸° ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    e.preventDefault();
    const clipboardData = (e.clipboardData || window.clipboardData).getData('text');
    if(!clipboardData) return;

    // 3. ì¤„ë°”ê¿ˆ(\n)ìœ¼ë¡œ í–‰ ë¶„ë¦¬
    const rows = clipboardData.trim().split(/\r?\n/);
    if(rows.length === 0) return;

    if(!confirm(`${rows.length}ê°œì˜ ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

    // 4. ë°ì´í„° íŒŒì‹± (íƒ­ \t ìœ¼ë¡œ ì—´ ë¶„ë¦¬)
    // ì—‘ì…€ ìˆœì„œ ê°€ì •: [ID] [ë‹‰ë„¤ì„] [ê¸ˆì•¡] [1+1] [ê³µì•½] (ì‚¬ìš©ìê°€ ì´ ìˆœì„œë¡œ ë³µì‚¬í–ˆë‹¤ê³  ê°€ì •)
    rows.forEach(rowStr => {
        const cols = rowStr.split('\t');
        // ìµœì†Œí•œ ë‹‰ë„¤ì„ì´ë‚˜ ê¸ˆì•¡ì€ ìˆì–´ì•¼ í•¨
        if(cols.length < 2 && !cols[0]) return;

        const newItem = {
            id: cols[0] || '',
            nick: cols[1] || '',
            amount: (cols[2] || '').replace(/[^0-9]/g, ''), // ìˆ«ìë§Œ ì¶”ì¶œ
            oneplus: cols[3] || '',
            promise: cols[4] || '' // 5ë²ˆì§¸ ì—´ì´ ìˆë‹¤ë©´ ê³µì•½ìœ¼ë¡œ
        };
        window.seasonData[window.currentSeasonName].push(newItem);
    });

    window.saveSeason();
    renderRecordTable(window.currentSeasonName);
  });


  // =================================================================
  // [ìº˜ë¦°ë” ë¡œì§] (ê¸°ì¡´ ì½”ë“œ ìµœì†Œí™”í•˜ì—¬ ìœ ì§€)
  // =================================================================
  window.currentDate = new Date();
  window.selectedDateKey = null;
  window.currentTaskIndex = null;
  window.isEditMode = false;

  function refreshCalendarUI() {
    renderCalendar();
    renderSidebar();
    if(window.selectedDateKey) renderNickList(window.homeworkData[window.selectedDateKey] || []);
  }

  window.renderCalendar = () => {
    const year = window.currentDate.getFullYear();
    const month = window.currentDate.getMonth();
    document.getElementById('current-month').innerText = `${year}ë…„ ${month+1}ì›”`;
    const el = document.getElementById('calendar'); el.innerHTML = '';
    
    const firstDay = new Date(year, month, 1).getDay();
    const lastDate = new Date(year, month+1, 0).getDate();

    ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].forEach(d => el.innerHTML+=`<div class="day-name">${d}</div>`);
    for(let i=0; i<firstDay; i++) el.innerHTML+=`<div></div>`;
    
    for(let i=1; i<=lastDate; i++) {
        const dKey = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
        const count = (window.homeworkData[dKey]||[]).length;
        const cls = count>0 ? 'has-homework' : '';
        const badge = count>0 ? `<div class="hw-badge">${count}</div>` : '';
        el.innerHTML += `<div class="day-cell ${cls}" onclick="selectDate('${dKey}')"><span class="day-number">${i}</span>${badge}</div>`;
    }
  };

  window.changeMonth = (step) => { window.currentDate.setMonth(window.currentDate.getMonth()+step); window.renderCalendar(); };
  
  window.selectDate = (key) => {
    window.selectedDateKey = key;
    document.getElementById('selected-date-text').innerText = `${key} ë¦¬ìŠ¤íŠ¸`;
    renderNickList(window.homeworkData[key]||[]);
    document.getElementById('nickname-view').style.display='block';
    document.getElementById('detail-card').style.display='none';
    document.getElementById('add-form').style.display='none';
  };

  window.renderNickList = (list) => {
    const con = document.getElementById('nick-list-container'); con.innerHTML = '';
    if(!list.length) { con.innerHTML = '<div style="grid-column:span 3; text-align:center; color:#ccc;">ì—†ìŒ</div>'; return; }
    list.forEach((task, idx) => {
        const btn = document.createElement('button');
        btn.className = 'nick-btn';
        if(task.status === 'done') btn.style.background = '#e8f5e9';
        btn.innerText = task.nick;
        btn.onclick = () => showMemberDetail(task, idx);
        con.appendChild(btn);
    });
  };

  window.renderSidebar = () => {
    const con = document.getElementById('sidebar-list'); con.innerHTML = '';
    Object.keys(window.homeworkData).sort().reverse().forEach(key => {
        if(window.homeworkData[key].length > 0) {
            const div = document.createElement('div');
            div.className = 'shortcut-btn';
            div.innerHTML = `<span>${key}</span><span style="background:var(--primary-pink); color:white; padding:2px 6px; border-radius:10px; font-size:11px;">${window.homeworkData[key].length}</span>`;
            div.onclick = () => { 
                window.currentDate = new Date(key); 
                window.renderCalendar(); 
                window.selectDate(key); 
            };
            con.appendChild(div);
        }
    });
  };

  // ìº˜ë¦°ë” ë“±ë¡/ìˆ˜ì • ë¡œì§
  window.toggleAddForm = () => {
    window.isEditMode = false;
    document.getElementById('add-form').style.display = 'block';
    document.getElementById('new-date').value = window.selectedDateKey;
    document.getElementById('new-nick').value = '';
    document.getElementById('new-id').value = '';
    document.getElementById('new-amount').value = '';
    document.getElementById('new-reverse').value = '';
    document.getElementById('new-content').value = '';
    document.getElementById('btn-submit').innerText = 'ë“±ë¡í•˜ê¸°';
  };

  window.openEditForm = () => {
    window.isEditMode = true;
    const task = window.homeworkData[window.selectedDateKey][window.currentTaskIndex];
    document.getElementById('add-form').style.display = 'block';
    document.getElementById('new-date').value = window.selectedDateKey;
    document.getElementById('new-nick').value = task.nick;
    document.getElementById('new-id').value = task.id;
    document.getElementById('new-amount').value = task.amount;
    document.getElementById('new-reverse').value = task.reverse;
    document.getElementById('new-content').value = task.content;
    document.getElementById('btn-submit').innerText = 'ìˆ˜ì •ì™„ë£Œ';
    document.getElementById('detail-card').style.display = 'none';
  };

  window.autoCalculate = () => {
    const amt = document.getElementById('new-amount').value;
    const ratio = document.querySelector('input[name="calc-ratio"]:checked').value;
    document.getElementById('new-reverse').value = Math.floor(amt * ratio);
  };

  window.handleTaskSubmit = () => {
    const dKey = document.getElementById('new-date').value;
    if(!dKey) return alert("ë‚ ì§œ ì„ íƒ í•„ìˆ˜");
    
    const newTask = {
        nick: document.getElementById('new-nick').value,
        id: document.getElementById('new-id').value,
        amount: document.getElementById('new-amount').value,
        reverse: document.getElementById('new-reverse').value,
        content: document.getElementById('new-content').value,
        status: 'todo', memo: ''
    };

    if(window.isEditMode) {
        // ê¸°ì¡´ ì‚­ì œ í›„ ì¶”ê°€ (ë‚ ì§œ ë³€ê²½ ëŒ€ì‘)
        window.homeworkData[window.selectedDateKey].splice(window.currentTaskIndex, 1);
    }
    
    if(!window.homeworkData[dKey]) window.homeworkData[dKey] = [];
    window.homeworkData[dKey].push(newTask);
    
    window.saveHomework();
    document.getElementById('add-form').style.display = 'none';
    if(dKey === window.selectedDateKey) window.selectDate(dKey);
    else window.renderCalendar();
  };

  window.showMemberDetail = (task, idx) => {
    window.currentTaskIndex = idx;
    document.getElementById('detail-card').style.display = 'block';
    document.getElementById('detail-nick').innerText = task.nick;
    document.getElementById('detail-id').innerText = task.id;
    document.getElementById('detail-amount').innerText = parseInt(task.amount).toLocaleString();
    document.getElementById('detail-reverse').innerText = parseInt(task.reverse).toLocaleString();
    document.getElementById('detail-content').innerText = task.content;
    document.getElementById('detail-memo').value = task.memo || '';
    document.getElementById('detail-link').href = `https://www.sooplive.co.kr/station/${task.id}`;
  };

  window.saveTaskStatus = () => {
    if(!window.selectedDateKey) return;
    const task = window.homeworkData[window.selectedDateKey][window.currentTaskIndex];
    task.memo = document.getElementById('detail-memo').value;
    window.saveHomework();
  };

  window.completeAndDelete = () => {
    if(!confirm("ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì‚­ì œë¨)")) return;
    window.deleteTask();
  };

  window.deleteTask = () => {
    window.homeworkData[window.selectedDateKey].splice(window.currentTaskIndex, 1);
    window.saveHomework();
    window.closeDetail();
    window.selectDate(window.selectedDateKey);
  };

  window.closeDetail = () => document.getElementById('detail-card').style.display = 'none';

</script>

</body>
</html>
